var district_data=[],product_dist_data=[];const product_list={no2:{id:"no2",label:"Nitrogen dioxide - NO₂",unit:"µmol/㎡",threshold:20},so2:{id:"so2",label:"Sulfur dioxide - SO₂",unit:"µmol/㎡",threshold:65},co:{id:"co",label:"Carbon monoxide - CO",unit:"µmol/㎡",threshold:1e4},hcho:{id:"hcho",label:"Formaldehyde - HCHO",unit:"µmol/㎡",threshold:20},o3:{id:"o3",label:"Ozone - O3",unit:"µmol/㎡",threshold:0},pm25:{id:"pm25",label:"Bụi mịn PM2.5",unit:"µg/m³",threshold:20,max:500}};function customRange(t){if("todate"==t.id){var e=new Date($("#fromdate").val());return e.setDate(e.getDate()+1),{minDate:e}}return{}}function formatDateYYYYMMDD(t){var e=t.split("-");return e[2]+"-"+e[1]+"-"+e[0]}var ctx=null,my_chart=null;function initChart(){(ctx=document.getElementById("my_chart").getContext("2d")).fillStyle="white",my_chart=new Chart(ctx,{type:"line",data:{labels:[],datasets:[]},options:{scales:{y:{suggestedMax:250,suggestedMin:0,beginAtZero:!0}},responsive:!0,plugins:{}}})}function triggerDownloadChartImg(){$("#btn-download-chart").click((function(){var t=$("#fromdate").val(),e=$("#todate").val(),a=$("#selectDistrict").find(":selected").val(),o=$("#selectProduct").find(":selected").val(),r=document.createElement("a");r.href=getChartImgBase64(my_chart),r.download=o+"_"+a+"_"+t+"_"+e+".png",console.log(r),r.click()}))}function getChartImgBase64(t){return t.toBase64Image()}function triggerDownloadExcel(){$("#btn-download-excel").click((function(){console.log("Export Excel File",product_dist_data);var t=[],e=product_dist_data.dist._id,a=$("#fromdate").val(),o=$("#todate").val(),r=$("#selectDistrict").find(":selected").val(),d=$("#selectProduct").find(":selected").val();if(product_dist_data.data&&product_dist_data.data.length){var l=product_dist_data.data;for(var i in l){var n={Location:e,Date:l[i].date,Value:parseFloat(l[i].val).toFixed(2),Forecast:""};t.push(n)}}if(product_dist_data.data_pred&&product_dist_data.data_pred.length){l=product_dist_data.data_pred;for(var i in l){n={Location:e,Date:l[i].date,Value:"",Forecast:parseFloat(l[i].val_pred).toFixed(2)};t.push(n)}}console.log("Excel data: ",t),JSONToCSVConvertor(t,d+"_"+r+"_"+a+"_"+o,!0)}))}function JSONToCSVConvertor(t,e,a){var o="object"!=typeof t?JSON.parse(t):t,r="sep=,\r\n\n";if(a){var d="";for(var l in o[0])d+=l+",";r+=(d=d.slice(0,-1))+"\r\n"}for(var i=0;i<o.length;i++){d="";for(var l in o[i])d+='"'+o[i][l]+'",';d.slice(0,d.length-1),r+=d+"\r\n"}if(""!=r){var n="";n+=e.replace(/ /g,"_");var s="data:text/csv;charset=utf-8,"+escape(r),c=document.createElement("a");c.href=s,c.style="visibility:hidden",c.download=n+".csv",document.body.appendChild(c),c.click(),document.body.removeChild(c)}else alert("Invalid data")}$((function(){for(var t in $("#fromdate, #todate").datepicker({showOn:"both",beforeShow:customRange,dateFormat:"dd-mm-yy",regional:"vi"}),$("#fromdate").datepicker("setDate",-7),$("#todate").datepicker("setDate",5),product_list){var e=new Option(product_list[t].label,product_list[t].id);$(e).html(product_list[t].label),$("#selectProduct").append(e)}$.get("/get-district-all",{}).done((function(t){for(var e in district_data=JSON.parse(t)){var a=new Option(district_data[e].dist_name,district_data[e]._id);$(a).html(district_data[e].dist_name),$("#selectDistrict").append(a)}})),initChart(),$("#retriveData").click((function(){var t=$("#selectDistrict").find(":selected").val(),e=$("#selectProduct").find(":selected").val(),a=formatDateYYYYMMDD($("#fromdate").val()),o=formatDateYYYYMMDD($("#todate").val());t&&a&&o&&e?a>o?alert("Ngày bắt đầu phải bé hơn ngày kết thúc."):$.get("/get-product/"+e+"/"+t+"/"+a+"/"+o,{}).done((function(t){res=JSON.parse(t),product_dist_data=res,console.log("res data: ",res);var a=[],o=[],r=[];if(my_chart.data.datasets=[],res.data&&res.data.length?$(".btn-export").fadeIn():(alert("Dữ liệu không tồn tại hoặc đang cập nhật..."),$(".btn-export").fadeOut()),res.data&&res.data.length){console.log("res data: ",res.data);var d=res.data;for(var l in d)console.log("real value",d[l]),a.push(d[l].date),o.push(d[l].val);my_chart.data.datasets.push({label:"Giá trị thực tế",data:o,fill:!0,borderColor:"rgba(40, 167, 69, 0.7",backgroundColor:"rgba(40, 167, 69, 0.5",tension:.35,borderWidth:2,pointBorderWidth:1.23,pointRadius:1.5})}if(res.data_pred&&res.data_pred.length){console.log("res data predict: ",res.data_pred);var i=product_list[e].threshold,n=res.data_pred;for(var l in res.data)parseInt(l)==res.data.length-1?r.push(res.data[l].val):r.push(NaN);for(var l in n){console.log("predict",n[l]),a.push(n[l].date);var s=n[l].val_pred<i?0:n[l].val_pred;r.push(s)}my_chart.data.datasets.push({label:"Giá trị dự báo",data:r,fill:!0,borderColor:"rgba(20, 159, 255, 0.8)",backgroundColor:"rgba(20, 159, 255, 0.6)",tension:.35,borderWidth:2,pointBorderWidth:1.23,pointRadius:1.5}),console.log(r)}my_chart.data.labels=a,my_chart.options={plugins:{legend:{position:"top"},title:{display:!0,text:"Giá trị nồng độ "+product_list[e].label+" ("+product_list[e].unit+")",position:"top",font:{size:15},padding:{top:10,bottom:12}},tooltip:{titleFont:{size:14,lineHeight:1.5},bodyFont:{size:13.2,lineHeight:1.4},padding:10,caretPadding:5,callbacks:{beforeTitle:function(t){return product_list[e].label},title:function(t){return"Ngày: "+t[0].label},label:function(t){return" "+t.dataset.label+": "+t.formattedValue.toLocaleString("vi-VN")+" µmol/㎡"}}}}},my_chart.update()})):alert("Vui lòng nhập đầy đủ dữ liệu cần truy vấn.")})),triggerDownloadChartImg(),triggerDownloadExcel(),$("[data-toggle='tooltip']").tooltip()}));